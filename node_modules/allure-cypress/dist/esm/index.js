var u=function(t){return t.FAILED="failed",t.BROKEN="broken",t.PASSED="passed",t.SKIPPED="skipped",t}({}),J=[u.FAILED,u.BROKEN,u.PASSED,u.SKIPPED],q=function(t){return t.SCHEDULED="scheduled",t.RUNNING="running",t.FINISHED="finished",t.PENDING="pending",t.INTERRUPTED="interrupted",t}({}),l=function(t){return t.ALLURE_ID="ALLURE_ID",t.AS_ID="ALLURE_ID",t.SUITE="suite",t.PARENT_SUITE="parentSuite",t.SUB_SUITE="subSuite",t.EPIC="epic",t.FEATURE="feature",t.STORY="story",t.SEVERITY="severity",t.TAG="tag",t.OWNER="owner",t.LEAD="lead",t.HOST="host",t.THREAD="thread",t.TEST_METHOD="testMethod",t.TEST_CLASS="testClass",t.PACKAGE="package",t.FRAMEWORK="framework",t.LANGUAGE="language",t.LAYER="layer",t}({}),X=function(t){return t.BLOCKER="blocker",t.CRITICAL="critical",t.NORMAL="normal",t.MINOR="minor",t.TRIVIAL="trivial",t}({}),P=function(t){return t.TEXT="text/plain",t.XML="application/xml",t.HTML="text/html",t.CSV="text/csv",t.TSV="text/tab-separated-values",t.CSS="text/css",t.URI="text/uri-list",t.SVG="image/svg+xml",t.PNG="image/png",t.JSON="application/json",t.ZIP="application/zip",t.WEBM="video/webm",t.JPEG="image/jpeg",t.MP4="video/mp4",t.IMAGEDIFF="application/vnd.allure.image.diff",t}({}),E=function(t){return t.DEFAULT="link",t.ISSUE="issue",t.TMS="tms",t}({});function B(t,e,s,r,a,n,i){try{var p=t[n](i),o=p.value}catch(m){return void s(m)}p.done?e(o):Promise.resolve(o).then(r,a)}function c(t){return function(){var e=this,s=arguments;return new Promise(function(r,a){var n=t.apply(e,s);function i(o){B(n,r,a,i,p,"next",o)}function p(o){B(n,r,a,i,p,"throw",o)}i(void 0)})}}var w=class{attachment(){var e=this;return c(function*(){yield e.warning()})()}attachmentFromPath(){var e=this;return c(function*(){yield e.warning()})()}description(){var e=this;return c(function*(){yield e.warning()})()}descriptionHtml(){var e=this;return c(function*(){yield e.warning()})()}displayName(){var e=this;return c(function*(){yield e.warning()})()}historyId(){var e=this;return c(function*(){yield e.warning()})()}labels(){var e=this;return c(function*(){yield e.warning()})()}links(){var e=this;return c(function*(){yield e.warning()})()}parameter(){var e=this;return c(function*(){yield e.warning()})()}logStep(){var e=this;return c(function*(){yield e.warning()})()}step(e,s){var r=this;return c(function*(){return yield r.warning(),s()})()}stepDisplayName(){var e=this;return c(function*(){yield e.warning()})()}stepParameter(){var e=this;return c(function*(){yield e.warning()})()}testCaseId(){var e=this;return c(function*(){yield e.warning()})()}warning(){return c(function*(){console.log("no test runtime is found. Please check test framework configuration")})()}},v=new w;var V="allureTestRuntime",D=t=>{globalThis[V]=()=>t},I=()=>globalThis?.[V],y=()=>{var t=I();if(t){var e;return(e=t())!==null&&e!==void 0?e:v}return v},O=()=>{var t=I();if(t){var e;return(e=t())!==null&&e!==void 0?e:v}if("_playwrightInstance"in globalThis)try{return(0,eval)("(() => import('allure-playwright/autoconfig'))()").then(()=>{var s,r;return(s=(r=I())===null||r===void 0?void 0:r())!==null&&s!==void 0?s:v})}catch(s){return console.log("can't execute allure-playwright/autoconfig",s),v}return v};function M(){M=function(n,i){return new s(n,void 0,i)};var t=RegExp.prototype,e=new WeakMap;function s(a,n,i){var p=RegExp(a,n);return e.set(p,i||e.get(a)),T(p,s.prototype)}function r(a,n){var i=e.get(n);return Object.keys(i).reduce(function(p,o){var m=i[o];if(typeof m=="number")p[o]=a[m];else{for(var f=0;a[m[f]]===void 0&&f+1<m.length;)f++;p[o]=a[m[f]]}return p},Object.create(null))}return Q(s,RegExp),s.prototype.exec=function(a){var n=t.exec.call(this,a);if(n){n.groups=r(n,this);var i=n.indices;i&&(i.groups=r(i,this))}return n},s.prototype[Symbol.replace]=function(a,n){if(typeof n=="string"){var i=e.get(this);return t[Symbol.replace].call(this,a,n.replace(/\$<([^>]+)>/g,function(o,m){var f=i[m];return"$"+(Array.isArray(f)?f.join("$"):f)}))}if(typeof n=="function"){var p=this;return t[Symbol.replace].call(this,a,function(){var o=arguments;return typeof o[o.length-1]!="object"&&(o=[].slice.call(o)).push(r(o,p)),n.apply(this,o)})}return t[Symbol.replace].call(this,a,n)},M.apply(this,arguments)}function Q(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&T(t,e)}function T(t,e){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,r){return s.__proto__=r,s},T(t,e)}var ee=function(){var{onlyFirst:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},s=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(s,e?void 0:"g")},k=t=>{var e=ee();return t.replace(e,"")},x=t=>{var{message:e,stack:s}=t;return{message:e?k(e):void 0,trace:s?k(s):void 0}},K=M(/(?:^|\s)@?allure\.id[:=]([^\s]+)/,{id:1}),te=new RegExp(K,"g"),$=M(/(?:^|\s)@?allure\.label\.([^:=\s]+)[:=]([^\s]+)/,{name:1,value:2}),se=new RegExp($,"g"),N=t=>{var e=[];t.split(" ").forEach(r=>{var a,n=(a=r.match(K))===null||a===void 0||(a=a.groups)===null||a===void 0?void 0:a.id;n&&e.push({name:l.ALLURE_ID,value:n});var i=r.match($),{name:p,value:o}=i?.groups||{};p&&o&&e?.push({name:p,value:o})});var s=t.replace(se,"").replace(te,"").trim();return{labels:e,cleanTitle:s}};var G=t=>t.some(e=>e.type==="step_start"||e.type==="step_stop"),re=t=>t.reduce((e,s)=>{if(s.type!=="step_start"&&s.type!=="step_stop")return e;if(s.type==="step_start")return e.push([s]),e;var r=e.findLastIndex(a=>a.length===1);return r===-1||e[r].push(s),e},[]),R=t=>{var e=re(t);return e.filter(s=>s.length===1)},H=t=>!!t&&(typeof t=="object"||typeof t=="function")&&typeof t.then=="function";var d=function(e){for(var s=arguments.length,r=new Array(s>1?s-1:0),a=1;a<s;a++)r[a-1]=arguments[a];var n=O();return H(n)?n.then(i=>i[e](...r)):n[e](...r)},g=(t,e)=>d("labels",{name:t,value:e}),ae=function(){for(var e=arguments.length,s=new Array(e),r=0;r<e;r++)s[r]=arguments[r];return d("labels",...s)},L=(t,e,s)=>d("links",{url:t,type:s,name:e}),ne=function(){for(var e=arguments.length,s=new Array(e),r=0;r<e;r++)s[r]=arguments[r];return d("links",...s)},ie=(t,e,s)=>d("parameter",t,e,s),oe=t=>d("description",t),pe=t=>d("descriptionHtml",t),ue=t=>d("displayName",t),le=t=>d("historyId",t),de=t=>d("testCaseId",t),ce=(t,e,s)=>{var r=typeof s=="string"?{contentType:s}:s;return d("attachment",t,e,r)},me=(t,e,s)=>{var r=typeof s=="string"?{contentType:s}:s;return d("attachmentFromPath",t,e,r)},ye=()=>({displayName:t=>d("stepDisplayName",t),parameter:(t,e,s)=>d("stepParameter",t,e,s)}),ge=(t,e,s)=>d("logStep",t,e,s),fe=(t,e)=>d("step",t,()=>e(ye())),he=(t,e)=>L(t,e,E.ISSUE),ve=(t,e)=>L(t,e,E.TMS),_e=t=>g(l.ALLURE_ID,t),Se=t=>g(l.EPIC,t),Ee=t=>g(l.FEATURE,t),Me=t=>g(l.STORY,t),Te=t=>g(l.SUITE,t),xe=t=>g(l.PARENT_SUITE,t),Re=t=>g(l.SUB_SUITE,t),Ae=t=>g(l.OWNER,t),Ce=t=>g(l.SEVERITY,t),be=t=>g(l.LAYER,t),Pe=t=>g(l.TAG,t),we=function(){for(var e=arguments.length,s=new Array(e),r=0;r<e;r++)s[r]=arguments[r];return d("labels",...s.map(a=>({name:l.TAG,value:a})))};var _="__allure_report_system_hook__",S="__allure_report_step_command__";var z=t=>Array.isArray(t)||t.buffer?btoa(String.fromCharCode.apply(null,t)):t,A=t=>{let e=[],s=t.parent;for(;s;)s.title&&e.unshift(s.title),s=s.parent;return e},U=t=>Oe(t.attributes.args)?.log===!1||t.attributes.name==="task"&&t.attributes.args[0]==="allureReportTest"||t.attributes.name==="then"||t.attributes.name==="wrap"&&t.attributes.args[0]===S,j=t=>{let e=[];for(let s=t.length-1;s>=0;s--)e.push(t[s]);return e},C=t=>/(before|after) all/.test(t),Y=t=>t.includes("before")?"before":"after",Oe=t=>t[t.length-1],F=(t,e,s)=>{let r=`${e.relative}#${t.titlePath.join(" ")}`,{labels:a}=N(t.title),n=a.find(({name:i})=>i===l.ALLURE_ID);return s.tests.some(({id:i,selector:p=""})=>(i?String(i)===n?.value:!1)||p===r)};var b=class{labels(...e){return this.sendMessageAsync({type:"metadata",data:{labels:e}})}links(...e){return this.sendMessageAsync({type:"metadata",data:{links:e}})}parameter(e,s,r){return this.sendMessageAsync({type:"metadata",data:{parameters:[{name:e,value:s,...r}]}})}description(e){return this.sendMessageAsync({type:"metadata",data:{description:e}})}descriptionHtml(e){return this.sendMessageAsync({type:"metadata",data:{descriptionHtml:e}})}displayName(e){return this.sendMessageAsync({type:"metadata",data:{displayName:e}})}historyId(e){return this.sendMessageAsync({type:"metadata",data:{historyId:e}})}testCaseId(e){return this.sendMessageAsync({type:"metadata",data:{testCaseId:e}})}attachment(e,s,r){let a=s?.type==="Buffer"?s.data:s,n=typeof a=="string"?"utf8":"base64",i=z(a);return this.sendMessageAsync({type:"attachment_content",data:{name:e,content:i,encoding:n,contentType:r.contentType,fileExtension:r.fileExtension}})}attachmentFromPath(e,s,r){return this.sendMessageAsync({type:"attachment_path",data:{name:e,path:s,contentType:r.contentType,fileExtension:r.fileExtension}})}logStep(e,s=u.PASSED,r){return cy.wrap(S,{log:!1}).then(()=>(this.sendMessage({type:"step_start",data:{name:e,start:Date.now()}}),Cypress.Promise.resolve())).then(()=>this.sendMessageAsync({type:"step_stop",data:{status:s,stop:Date.now(),statusDetails:r?{...x(r)}:void 0}}))}step(e,s){return cy.wrap(S,{log:!1}).then(()=>(this.sendMessage({type:"step_start",data:{name:e,start:Date.now()}}),Cypress.Promise.resolve(s()))).then(r=>this.sendMessageAsync({type:"step_stop",data:{status:u.PASSED,stop:Date.now()}}).then(()=>r))}stepDisplayName(e){return this.sendMessageAsync({type:"step_metadata",data:{name:e}})}stepParameter(e,s,r){return this.sendMessageAsync({type:"step_metadata",data:{parameters:[{name:e,value:s,mode:r}]}})}sendMessage(e){let s=Cypress.env("allureRuntimeMessages")||[];Cypress.env("allureRuntimeMessages",s.concat(e))}sendMessageAsync({type:e,data:s}){return this.sendMessage({type:e,data:{...s,cypressTestId:Cypress.state("test")?.id??""}}),Cypress.Promise.resolve()}},{EVENT_RUN_BEGIN:ke,EVENT_RUN_END:Ne,EVENT_TEST_BEGIN:Ge,EVENT_TEST_FAIL:He,EVENT_TEST_PASS:Le,EVENT_TEST_PENDING:Ue,EVENT_SUITE_BEGIN:je,EVENT_SUITE_END:Fe,EVENT_HOOK_BEGIN:Be,EVENT_HOOK_END:Ve}=Mocha.Runner.constants,Ke=()=>{Cypress.env("allureInitialized")||(Cypress.env("allureInitialized",!0),Cypress.mocha.getRunner().on(ke,()=>{let e=new b;Cypress.env("allureRuntimeMessages",[]),D(e)}).on(Be,e=>{if(e.title.includes(_))return;let s=y(),r=Cypress.state()?.test?.id;s.sendMessageAsync({type:"cypress_hook_start",data:{id:r?`${r}:${e.hookId}`:"",parentId:e.parent.id,name:e.title,type:Y(e.title),start:Date.now(),global:C(e.title)}})}).on(Ve,e=>{if(e.title.includes(_))return;let s=y(),r=Cypress.env("allureRuntimeMessages"),a=j(r).find(({type:n})=>n==="cypress_hook_start");return a.data.id||(a.data.id=`${e.id}:${e.hookId}`),s.sendMessageAsync({type:"cypress_hook_end",data:{id:a.data.id,parentId:e.parent.id,status:u.PASSED,stop:a.data.start+(e.duration??0),global:C(e.title)}})}).on(je,e=>y().sendMessageAsync({type:"cypress_suite_start",data:{id:e.titlePath().join(" "),name:e.title}})).on(Fe,e=>y().sendMessageAsync({type:"cypress_suite_end",data:{id:e.titlePath().join(" ")}})).on(Ge,e=>{y().sendMessage({type:"cypress_test_start",data:{id:e.id,specPath:A(e).concat(e.title),filename:Cypress.spec.relative,start:e.wallClockStartedAt?.getTime()||Date.now()}})}).on(Le,e=>{let s=y(),r=Cypress.env("allureRuntimeMessages"),a=R(r),n=e._retries??0;a.forEach(()=>{s.sendMessage({type:"step_stop",data:{status:u.PASSED,stop:Date.now()}})}),s.sendMessage({type:"cypress_test_end",data:{id:e.id,status:u.PASSED,stop:Date.now(),retries:n}})}).on(He,(e,s)=>{let r=y(),a=Cypress.env("allureRuntimeMessages"),n=a.toReversed().findIndex(({type:h})=>h==="cypress_command_start"),i=a.toReversed().findIndex(({type:h})=>h==="cypress_command_end"),p=n>i,o=s.constructor.name==="AssertionError"?u.FAILED:u.BROKEN,m={message:s.message,trace:s.stack},f=e._retries??0;if(p&&r.sendMessage({type:"cypress_command_end",data:{id:a[n].data.id,status:o,statusDetails:m}}),e.hookName){let h=a.toReversed().find(({type:Z})=>Z==="cypress_hook_start");return r.sendMessageAsync({type:"cypress_hook_end",data:{id:h.data.id,status:o,statusDetails:m,stop:h.data.start+(e.duration??0),parentId:h.data.parentId,global:C(e.hookName)}})}!e.hookName&&e.wallClockStartedAt===void 0&&r.sendMessage({type:"cypress_test_start",data:{id:e.id,specPath:A(e).concat(e.title),filename:Cypress.spec.relative,start:Date.now()}});let W=j(a).find(({type:h})=>h==="cypress_test_start");r.sendMessage({type:"cypress_test_end",data:{id:e.id,status:o,statusDetails:m,stop:W.data.start+(e.duration??0),retries:f}})}).on(Ue,e=>{let s=new b,r=Cypress.env("allureTestPlan");if(r&&!F(Cypress.currentTest,Cypress.spec,r))return;let a=e._retries??0;return s.sendMessageAsync({type:"cypress_test_start",data:{id:e.id,specPath:A(e).concat(e.title),filename:Cypress.spec.relative,start:Date.now()}}),s.sendMessageAsync({type:"cypress_test_end",data:{id:e.id,status:u.SKIPPED,stop:Date.now(),retries:a}})}).on(Ne,()=>{Cypress.config("isInteractive")&&cy.task("allureReportSpec",{absolute:Cypress.spec.absolute})}),Cypress.Screenshot.defaults({onAfterScreenshot:(e,s)=>y().sendMessageAsync({type:"attachment_path",data:{path:s.path,name:s.name||"Screenshot",contentType:P.PNG}})}),Cypress.on("fail",e=>{let s=y(),r=Cypress.env("allureRuntimeMessages");if(!G(r))throw e;let n=R(r);if(n.length===0)throw e;let i=e.constructor.name==="AssertionError"?u.FAILED:u.BROKEN;throw n.forEach(()=>{s.sendMessage({type:"step_stop",data:{status:i,stop:Date.now(),statusDetails:{message:e.message,trace:e.stack}}})}),e}),Cypress.on("command:start",e=>U(e)?void 0:y().sendMessageAsync({type:"cypress_command_start",data:{id:e.attributes.id,name:`Command "${e.attributes.name}"`,args:e.attributes.args.map(r=>typeof r=="string"?r:JSON.stringify(r,null,2))}})),Cypress.on("command:end",e=>U(e)?void 0:y().sendMessageAsync({type:"cypress_command_end",data:{id:e.attributes.id,status:u.PASSED}})),before(_,()=>{cy.task("readAllureTestPlan",{},{log:!1}).then(e=>{e&&Cypress.env("allureTestPlan",e)})}),beforeEach(_,function(){let e=Cypress.env("allureTestPlan");e&&(F(Cypress.currentTest,Cypress.spec,e)||this.skip())}),after(_,()=>{let e=Cypress.env("allureRuntimeMessages");cy.task("allureReportTest",{absolutePath:Cypress.spec.absolute,messages:e??[]},{log:!1})}))};Ke();export{b as AllureCypressTestRuntime,P as ContentType,l as LabelName,E as LinkType,X as Severity,q as Stage,u as Status,J as StatusByPriority,_e as allureId,ce as attachment,me as attachmentPath,oe as description,pe as descriptionHtml,ue as displayName,Se as epic,Ee as feature,le as historyId,he as issue,g as label,ae as labels,be as layer,L as link,ne as links,ge as logStep,Ae as owner,ie as parameter,xe as parentSuite,Ce as severity,fe as step,Me as story,Re as subSuite,Te as suite,Pe as tag,we as tags,de as testCaseId,ve as tms};
//# sourceMappingURL=index.js.map
