"use strict";var I=Object.defineProperty;var Ae=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var be=Object.prototype.hasOwnProperty;var Pe=(t,e)=>{for(var s in e)I(t,s,{get:e[s],enumerable:!0})},we=(t,e,s,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of Ce(e))!be.call(t,a)&&a!==s&&I(t,a,{get:()=>e[a],enumerable:!(r=Ae(e,a))||r.enumerable});return t};var Ie=t=>we(I({},"__esModule",{value:!0}),t);var Xe={};Pe(Xe,{AllureCypressTestRuntime:()=>M,ContentType:()=>T,LabelName:()=>l,LinkType:()=>S,Severity:()=>$,Stage:()=>K,Status:()=>u,StatusByPriority:()=>V,allureId:()=>le,attachment:()=>ae,attachmentPath:()=>ne,description:()=>Q,descriptionHtml:()=>ee,displayName:()=>te,epic:()=>de,feature:()=>ce,historyId:()=>se,issue:()=>pe,label:()=>g,labels:()=>J,layer:()=>_e,link:()=>b,links:()=>q,logStep:()=>ie,owner:()=>he,parameter:()=>X,parentSuite:()=>ge,severity:()=>ve,step:()=>oe,story:()=>me,subSuite:()=>fe,suite:()=>ye,tag:()=>Se,tags:()=>Ee,testCaseId:()=>re,tms:()=>ue});module.exports=Ie(Xe);var u=function(t){return t.FAILED="failed",t.BROKEN="broken",t.PASSED="passed",t.SKIPPED="skipped",t}({}),V=[u.FAILED,u.BROKEN,u.PASSED,u.SKIPPED],K=function(t){return t.SCHEDULED="scheduled",t.RUNNING="running",t.FINISHED="finished",t.PENDING="pending",t.INTERRUPTED="interrupted",t}({}),l=function(t){return t.ALLURE_ID="ALLURE_ID",t.AS_ID="ALLURE_ID",t.SUITE="suite",t.PARENT_SUITE="parentSuite",t.SUB_SUITE="subSuite",t.EPIC="epic",t.FEATURE="feature",t.STORY="story",t.SEVERITY="severity",t.TAG="tag",t.OWNER="owner",t.LEAD="lead",t.HOST="host",t.THREAD="thread",t.TEST_METHOD="testMethod",t.TEST_CLASS="testClass",t.PACKAGE="package",t.FRAMEWORK="framework",t.LANGUAGE="language",t.LAYER="layer",t}({}),$=function(t){return t.BLOCKER="blocker",t.CRITICAL="critical",t.NORMAL="normal",t.MINOR="minor",t.TRIVIAL="trivial",t}({}),T=function(t){return t.TEXT="text/plain",t.XML="application/xml",t.HTML="text/html",t.CSV="text/csv",t.TSV="text/tab-separated-values",t.CSS="text/css",t.URI="text/uri-list",t.SVG="image/svg+xml",t.PNG="image/png",t.JSON="application/json",t.ZIP="application/zip",t.WEBM="video/webm",t.JPEG="image/jpeg",t.MP4="video/mp4",t.IMAGEDIFF="application/vnd.allure.image.diff",t}({}),S=function(t){return t.DEFAULT="link",t.ISSUE="issue",t.TMS="tms",t}({});function z(t,e,s,r,a,n,i){try{var p=t[n](i),o=p.value}catch(m){return void s(m)}p.done?e(o):Promise.resolve(o).then(r,a)}function c(t){return function(){var e=this,s=arguments;return new Promise(function(r,a){var n=t.apply(e,s);function i(o){z(n,r,a,i,p,"next",o)}function p(o){z(n,r,a,i,p,"throw",o)}i(void 0)})}}var D=class{attachment(){var e=this;return c(function*(){yield e.warning()})()}attachmentFromPath(){var e=this;return c(function*(){yield e.warning()})()}description(){var e=this;return c(function*(){yield e.warning()})()}descriptionHtml(){var e=this;return c(function*(){yield e.warning()})()}displayName(){var e=this;return c(function*(){yield e.warning()})()}historyId(){var e=this;return c(function*(){yield e.warning()})()}labels(){var e=this;return c(function*(){yield e.warning()})()}links(){var e=this;return c(function*(){yield e.warning()})()}parameter(){var e=this;return c(function*(){yield e.warning()})()}logStep(){var e=this;return c(function*(){yield e.warning()})()}step(e,s){var r=this;return c(function*(){return yield r.warning(),s()})()}stepDisplayName(){var e=this;return c(function*(){yield e.warning()})()}stepParameter(){var e=this;return c(function*(){yield e.warning()})()}testCaseId(){var e=this;return c(function*(){yield e.warning()})()}warning(){return c(function*(){console.log("no test runtime is found. Please check test framework configuration")})()}},v=new D;var Y="allureTestRuntime",k=t=>{globalThis[Y]=()=>t},O=()=>globalThis?.[Y],y=()=>{var t=O();if(t){var e;return(e=t())!==null&&e!==void 0?e:v}return v},N=()=>{var t=O();if(t){var e;return(e=t())!==null&&e!==void 0?e:v}if("_playwrightInstance"in globalThis)try{return(0,eval)("(() => import('allure-playwright/autoconfig'))()").then(()=>{var s,r;return(s=(r=O())===null||r===void 0?void 0:r())!==null&&s!==void 0?s:v})}catch(s){return console.log("can't execute allure-playwright/autoconfig",s),v}return v};function x(){x=function(n,i){return new s(n,void 0,i)};var t=RegExp.prototype,e=new WeakMap;function s(a,n,i){var p=RegExp(a,n);return e.set(p,i||e.get(a)),R(p,s.prototype)}function r(a,n){var i=e.get(n);return Object.keys(i).reduce(function(p,o){var m=i[o];if(typeof m=="number")p[o]=a[m];else{for(var f=0;a[m[f]]===void 0&&f+1<m.length;)f++;p[o]=a[m[f]]}return p},Object.create(null))}return De(s,RegExp),s.prototype.exec=function(a){var n=t.exec.call(this,a);if(n){n.groups=r(n,this);var i=n.indices;i&&(i.groups=r(i,this))}return n},s.prototype[Symbol.replace]=function(a,n){if(typeof n=="string"){var i=e.get(this);return t[Symbol.replace].call(this,a,n.replace(/\$<([^>]+)>/g,function(o,m){var f=i[m];return"$"+(Array.isArray(f)?f.join("$"):f)}))}if(typeof n=="function"){var p=this;return t[Symbol.replace].call(this,a,function(){var o=arguments;return typeof o[o.length-1]!="object"&&(o=[].slice.call(o)).push(r(o,p)),n.apply(this,o)})}return t[Symbol.replace].call(this,a,n)},x.apply(this,arguments)}function De(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&R(t,e)}function R(t,e){return R=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(s,r){return s.__proto__=r,s},R(t,e)}var Oe=function(){var{onlyFirst:e=!1}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},s=["[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?\\u0007)","(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))"].join("|");return new RegExp(s,e?void 0:"g")},G=t=>{var e=Oe();return t.replace(e,"")},A=t=>{var{message:e,stack:s}=t;return{message:e?G(e):void 0,trace:s?G(s):void 0}},W=x(/(?:^|\s)@?allure\.id[:=]([^\s]+)/,{id:1}),ke=new RegExp(W,"g"),Z=x(/(?:^|\s)@?allure\.label\.([^:=\s]+)[:=]([^\s]+)/,{name:1,value:2}),Ne=new RegExp(Z,"g"),H=t=>{var e=[];t.split(" ").forEach(r=>{var a,n=(a=r.match(W))===null||a===void 0||(a=a.groups)===null||a===void 0?void 0:a.id;n&&e.push({name:l.ALLURE_ID,value:n});var i=r.match(Z),{name:p,value:o}=i?.groups||{};p&&o&&e?.push({name:p,value:o})});var s=t.replace(Ne,"").replace(ke,"").trim();return{labels:e,cleanTitle:s}};var L=t=>t.some(e=>e.type==="step_start"||e.type==="step_stop"),Ge=t=>t.reduce((e,s)=>{if(s.type!=="step_start"&&s.type!=="step_stop")return e;if(s.type==="step_start")return e.push([s]),e;var r=e.findLastIndex(a=>a.length===1);return r===-1||e[r].push(s),e},[]),C=t=>{var e=Ge(t);return e.filter(s=>s.length===1)},U=t=>!!t&&(typeof t=="object"||typeof t=="function")&&typeof t.then=="function";var d=function(e){for(var s=arguments.length,r=new Array(s>1?s-1:0),a=1;a<s;a++)r[a-1]=arguments[a];var n=N();return U(n)?n.then(i=>i[e](...r)):n[e](...r)},g=(t,e)=>d("labels",{name:t,value:e}),J=function(){for(var e=arguments.length,s=new Array(e),r=0;r<e;r++)s[r]=arguments[r];return d("labels",...s)},b=(t,e,s)=>d("links",{url:t,type:s,name:e}),q=function(){for(var e=arguments.length,s=new Array(e),r=0;r<e;r++)s[r]=arguments[r];return d("links",...s)},X=(t,e,s)=>d("parameter",t,e,s),Q=t=>d("description",t),ee=t=>d("descriptionHtml",t),te=t=>d("displayName",t),se=t=>d("historyId",t),re=t=>d("testCaseId",t),ae=(t,e,s)=>{var r=typeof s=="string"?{contentType:s}:s;return d("attachment",t,e,r)},ne=(t,e,s)=>{var r=typeof s=="string"?{contentType:s}:s;return d("attachmentFromPath",t,e,r)},He=()=>({displayName:t=>d("stepDisplayName",t),parameter:(t,e,s)=>d("stepParameter",t,e,s)}),ie=(t,e,s)=>d("logStep",t,e,s),oe=(t,e)=>d("step",t,()=>e(He())),pe=(t,e)=>b(t,e,S.ISSUE),ue=(t,e)=>b(t,e,S.TMS),le=t=>g(l.ALLURE_ID,t),de=t=>g(l.EPIC,t),ce=t=>g(l.FEATURE,t),me=t=>g(l.STORY,t),ye=t=>g(l.SUITE,t),ge=t=>g(l.PARENT_SUITE,t),fe=t=>g(l.SUB_SUITE,t),he=t=>g(l.OWNER,t),ve=t=>g(l.SEVERITY,t),_e=t=>g(l.LAYER,t),Se=t=>g(l.TAG,t),Ee=function(){for(var e=arguments.length,s=new Array(e),r=0;r<e;r++)s[r]=arguments[r];return d("labels",...s.map(a=>({name:l.TAG,value:a})))};var _="__allure_report_system_hook__",E="__allure_report_step_command__";var Me=t=>Array.isArray(t)||t.buffer?btoa(String.fromCharCode.apply(null,t)):t,P=t=>{let e=[],s=t.parent;for(;s;)s.title&&e.unshift(s.title),s=s.parent;return e},j=t=>je(t.attributes.args)?.log===!1||t.attributes.name==="task"&&t.attributes.args[0]==="allureReportTest"||t.attributes.name==="then"||t.attributes.name==="wrap"&&t.attributes.args[0]===E,F=t=>{let e=[];for(let s=t.length-1;s>=0;s--)e.push(t[s]);return e},w=t=>/(before|after) all/.test(t),Te=t=>t.includes("before")?"before":"after",je=t=>t[t.length-1],B=(t,e,s)=>{let r=`${e.relative}#${t.titlePath.join(" ")}`,{labels:a}=H(t.title),n=a.find(({name:i})=>i===l.ALLURE_ID);return s.tests.some(({id:i,selector:p=""})=>(i?String(i)===n?.value:!1)||p===r)};var M=class{labels(...e){return this.sendMessageAsync({type:"metadata",data:{labels:e}})}links(...e){return this.sendMessageAsync({type:"metadata",data:{links:e}})}parameter(e,s,r){return this.sendMessageAsync({type:"metadata",data:{parameters:[{name:e,value:s,...r}]}})}description(e){return this.sendMessageAsync({type:"metadata",data:{description:e}})}descriptionHtml(e){return this.sendMessageAsync({type:"metadata",data:{descriptionHtml:e}})}displayName(e){return this.sendMessageAsync({type:"metadata",data:{displayName:e}})}historyId(e){return this.sendMessageAsync({type:"metadata",data:{historyId:e}})}testCaseId(e){return this.sendMessageAsync({type:"metadata",data:{testCaseId:e}})}attachment(e,s,r){let a=s?.type==="Buffer"?s.data:s,n=typeof a=="string"?"utf8":"base64",i=Me(a);return this.sendMessageAsync({type:"attachment_content",data:{name:e,content:i,encoding:n,contentType:r.contentType,fileExtension:r.fileExtension}})}attachmentFromPath(e,s,r){return this.sendMessageAsync({type:"attachment_path",data:{name:e,path:s,contentType:r.contentType,fileExtension:r.fileExtension}})}logStep(e,s=u.PASSED,r){return cy.wrap(E,{log:!1}).then(()=>(this.sendMessage({type:"step_start",data:{name:e,start:Date.now()}}),Cypress.Promise.resolve())).then(()=>this.sendMessageAsync({type:"step_stop",data:{status:s,stop:Date.now(),statusDetails:r?{...A(r)}:void 0}}))}step(e,s){return cy.wrap(E,{log:!1}).then(()=>(this.sendMessage({type:"step_start",data:{name:e,start:Date.now()}}),Cypress.Promise.resolve(s()))).then(r=>this.sendMessageAsync({type:"step_stop",data:{status:u.PASSED,stop:Date.now()}}).then(()=>r))}stepDisplayName(e){return this.sendMessageAsync({type:"step_metadata",data:{name:e}})}stepParameter(e,s,r){return this.sendMessageAsync({type:"step_metadata",data:{parameters:[{name:e,value:s,mode:r}]}})}sendMessage(e){let s=Cypress.env("allureRuntimeMessages")||[];Cypress.env("allureRuntimeMessages",s.concat(e))}sendMessageAsync({type:e,data:s}){return this.sendMessage({type:e,data:{...s,cypressTestId:Cypress.state("test")?.id??""}}),Cypress.Promise.resolve()}},{EVENT_RUN_BEGIN:Fe,EVENT_RUN_END:Be,EVENT_TEST_BEGIN:Ve,EVENT_TEST_FAIL:Ke,EVENT_TEST_PASS:$e,EVENT_TEST_PENDING:ze,EVENT_SUITE_BEGIN:Ye,EVENT_SUITE_END:We,EVENT_HOOK_BEGIN:Ze,EVENT_HOOK_END:Je}=Mocha.Runner.constants,qe=()=>{Cypress.env("allureInitialized")||(Cypress.env("allureInitialized",!0),Cypress.mocha.getRunner().on(Fe,()=>{let e=new M;Cypress.env("allureRuntimeMessages",[]),k(e)}).on(Ze,e=>{if(e.title.includes(_))return;let s=y(),r=Cypress.state()?.test?.id;s.sendMessageAsync({type:"cypress_hook_start",data:{id:r?`${r}:${e.hookId}`:"",parentId:e.parent.id,name:e.title,type:Te(e.title),start:Date.now(),global:w(e.title)}})}).on(Je,e=>{if(e.title.includes(_))return;let s=y(),r=Cypress.env("allureRuntimeMessages"),a=F(r).find(({type:n})=>n==="cypress_hook_start");return a.data.id||(a.data.id=`${e.id}:${e.hookId}`),s.sendMessageAsync({type:"cypress_hook_end",data:{id:a.data.id,parentId:e.parent.id,status:u.PASSED,stop:a.data.start+(e.duration??0),global:w(e.title)}})}).on(Ye,e=>y().sendMessageAsync({type:"cypress_suite_start",data:{id:e.titlePath().join(" "),name:e.title}})).on(We,e=>y().sendMessageAsync({type:"cypress_suite_end",data:{id:e.titlePath().join(" ")}})).on(Ve,e=>{y().sendMessage({type:"cypress_test_start",data:{id:e.id,specPath:P(e).concat(e.title),filename:Cypress.spec.relative,start:e.wallClockStartedAt?.getTime()||Date.now()}})}).on($e,e=>{let s=y(),r=Cypress.env("allureRuntimeMessages"),a=C(r),n=e._retries??0;a.forEach(()=>{s.sendMessage({type:"step_stop",data:{status:u.PASSED,stop:Date.now()}})}),s.sendMessage({type:"cypress_test_end",data:{id:e.id,status:u.PASSED,stop:Date.now(),retries:n}})}).on(Ke,(e,s)=>{let r=y(),a=Cypress.env("allureRuntimeMessages"),n=a.toReversed().findIndex(({type:h})=>h==="cypress_command_start"),i=a.toReversed().findIndex(({type:h})=>h==="cypress_command_end"),p=n>i,o=s.constructor.name==="AssertionError"?u.FAILED:u.BROKEN,m={message:s.message,trace:s.stack},f=e._retries??0;if(p&&r.sendMessage({type:"cypress_command_end",data:{id:a[n].data.id,status:o,statusDetails:m}}),e.hookName){let h=a.toReversed().find(({type:Re})=>Re==="cypress_hook_start");return r.sendMessageAsync({type:"cypress_hook_end",data:{id:h.data.id,status:o,statusDetails:m,stop:h.data.start+(e.duration??0),parentId:h.data.parentId,global:w(e.hookName)}})}!e.hookName&&e.wallClockStartedAt===void 0&&r.sendMessage({type:"cypress_test_start",data:{id:e.id,specPath:P(e).concat(e.title),filename:Cypress.spec.relative,start:Date.now()}});let xe=F(a).find(({type:h})=>h==="cypress_test_start");r.sendMessage({type:"cypress_test_end",data:{id:e.id,status:o,statusDetails:m,stop:xe.data.start+(e.duration??0),retries:f}})}).on(ze,e=>{let s=new M,r=Cypress.env("allureTestPlan");if(r&&!B(Cypress.currentTest,Cypress.spec,r))return;let a=e._retries??0;return s.sendMessageAsync({type:"cypress_test_start",data:{id:e.id,specPath:P(e).concat(e.title),filename:Cypress.spec.relative,start:Date.now()}}),s.sendMessageAsync({type:"cypress_test_end",data:{id:e.id,status:u.SKIPPED,stop:Date.now(),retries:a}})}).on(Be,()=>{Cypress.config("isInteractive")&&cy.task("allureReportSpec",{absolute:Cypress.spec.absolute})}),Cypress.Screenshot.defaults({onAfterScreenshot:(e,s)=>y().sendMessageAsync({type:"attachment_path",data:{path:s.path,name:s.name||"Screenshot",contentType:T.PNG}})}),Cypress.on("fail",e=>{let s=y(),r=Cypress.env("allureRuntimeMessages");if(!L(r))throw e;let n=C(r);if(n.length===0)throw e;let i=e.constructor.name==="AssertionError"?u.FAILED:u.BROKEN;throw n.forEach(()=>{s.sendMessage({type:"step_stop",data:{status:i,stop:Date.now(),statusDetails:{message:e.message,trace:e.stack}}})}),e}),Cypress.on("command:start",e=>j(e)?void 0:y().sendMessageAsync({type:"cypress_command_start",data:{id:e.attributes.id,name:`Command "${e.attributes.name}"`,args:e.attributes.args.map(r=>typeof r=="string"?r:JSON.stringify(r,null,2))}})),Cypress.on("command:end",e=>j(e)?void 0:y().sendMessageAsync({type:"cypress_command_end",data:{id:e.attributes.id,status:u.PASSED}})),before(_,()=>{cy.task("readAllureTestPlan",{},{log:!1}).then(e=>{e&&Cypress.env("allureTestPlan",e)})}),beforeEach(_,function(){let e=Cypress.env("allureTestPlan");e&&(B(Cypress.currentTest,Cypress.spec,e)||this.skip())}),after(_,()=>{let e=Cypress.env("allureRuntimeMessages");cy.task("allureReportTest",{absolutePath:Cypress.spec.absolute,messages:e??[]},{log:!1})}))};qe();
//# sourceMappingURL=index.js.map
